<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tenant CBT Admin Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .card-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .card p {
            color: #7f8c8d;
            line-height: 1.6;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e8ed;
            border-radius: 15px;
            background: #f8f9fa;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .response pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tenants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tenant-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tenant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tenant-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .tenant-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-suspended {
            background: #fff3cd;
            color: #856404;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .tenant-info {
            margin-bottom: 15px;
        }

        .tenant-info p {
            margin: 5px 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .tenant-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }

        .back-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè´ Multi-Tenant CBT Admin Platform</h1>
            <p>Manage School Institutions and Their Admin Accounts</p>
            <div id="userInfo" style="margin-top: 15px; display: none;">
                <span id="currentUserName" style="margin-right: 15px;"></span>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 15px; font-size: 12px;">Logout</button>
            </div>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="loginSection" class="section active">
                <h2>üîê Admin Authentication</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="loginUsername">Username:</label>
                        <input type="text" id="loginUsername" placeholder="superadmin">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="superadmin123">
                    </div>
                </div>
                <button class="btn btn-success" onclick="login()">Login</button>
                <div id="loginResult" class="response"></div>
            </div>

            <!-- Main Dashboard -->
            <div id="mainDashboard" style="display: none;">
                <div class="dashboard">
                    <div class="card" onclick="showCreateAccount()">
                        <div class="card-icon">‚ûï</div>
                        <h2>Create New Account</h2>
                        <p>Set up a new school institution with admin credentials, contact information, and subscription details.</p>
                    </div>
                    <div class="card" onclick="showManageAccounts()">
                        <div class="card-icon">‚öôÔ∏è</div>
                        <h2>Manage Accounts</h2>
                        <p>View, suspend, activate, or remove existing school accounts. Monitor usage and expiration dates.</p>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTenants">-</div>
                        <div class="stat-label">Total Institutions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeTenants">-</div>
                        <div class="stat-label">Active Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="suspendedTenants">-</div>
                        <div class="stat-label">Suspended Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="expiringSoon">-</div>
                        <div class="stat-label">Expiring Soon</div>
                    </div>
                </div>
            </div>

            <!-- Create Account Section -->
            <div id="createAccountSection" class="section">
                <button class="back-btn" onclick="showMainDashboard()">‚Üê Back to Dashboard</button>
                <h2>‚ûï Create New School Account</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="institutionName">Institution Name *</label>
                        <input type="text" id="institutionName" placeholder="e.g., College of Nursing Sciences">
                    </div>
                    <div class="form-group">
                        <label for="institutionAddress">Institution Address</label>
                        <textarea id="institutionAddress" rows="2" placeholder="123 Nursing Street, Lagos"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="institutionPhone">Institution Phone</label>
                        <input type="text" id="institutionPhone" placeholder="+2348012345678">
                    </div>
                    <div class="form-group">
                        <label for="subscriptionPlan">Subscription Plan *</label>
                        <select id="subscriptionPlan">
                            <option value="basic">Basic</option>
                            <option value="premium">Premium</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="timezone">Timezone</label>
                        <select id="timezone">
                            <option value="Africa/Lagos">Africa/Lagos</option>
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="Europe/London">Europe/London</option>
                        </select>
                    </div>
                </div>

                                 <h3>Admin Account Details</h3>
                 <div class="form-grid">
                     <div class="form-group">
                         <label for="adminName">Admin Full Name *</label>
                         <input type="text" id="adminName" placeholder="e.g., John Doe">
                     </div>
                     <div class="form-group">
                         <label for="adminEmail">Admin Email *</label>
                         <input type="email" id="adminEmail" placeholder="admin@institution.edu.ng" onchange="generateUsername()">
                     </div>
                     <div class="form-group">
                         <label for="adminUsername">Admin Username *</label>
                         <input type="text" id="adminUsername" placeholder="Will be auto-generated from email">
                     </div>
                     <div class="form-group">
                         <label for="adminPhone">Admin Phone</label>
                         <input type="text" id="adminPhone" placeholder="+2348012345678">
                     </div>
                     <div class="form-group">
                         <label for="adminPassword">Admin Password *</label>
                         <input type="password" id="adminPassword" placeholder="Enter secure password">
                     </div>
                 </div>

                <button class="btn btn-success" onclick="createTenant()">Create Institution Account</button>
                <div id="createResult" class="response"></div>
            </div>

            <!-- Manage Accounts Section -->
            <div id="manageAccountsSection" class="section">
                <button class="back-btn" onclick="showMainDashboard()">‚Üê Back to Dashboard</button>
                <h2>‚öôÔ∏è Manage Institution Accounts</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadTenants()">üîÑ Refresh Accounts</button>
                    <button class="btn btn-secondary" onclick="exportTenants()">üìä Export Data</button>
                </div>

                <div id="tenantsList" class="tenants-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading institution accounts...</p>
                    </div>
                </div>
            </div>

            <!-- Configuration Section (Hidden by default) -->
            <div id="configSection" class="section">
                <button class="back-btn" onclick="showMainDashboard()">‚Üê Back to Dashboard</button>
                <h2>‚öôÔ∏è System Configuration</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="apiBase">API Base URL:</label>
                        <input type="text" id="apiBase" value="https://cbt-rew7.onrender.com" placeholder="https://your-api.com">
                    </div>
                </div>
                <button class="btn" onclick="testConnection()">Test Connection</button>
                <div id="configResult" class="response"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = document.getElementById('apiBase');
        let authToken = null;
        let currentUser = null;

        function getApiUrl(endpoint) {
            return `${API_BASE.value}${endpoint}`;
        }

        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            // For now, always include admin token to bypass authentication
            headers['Authorization'] = 'Bearer admin-token';
            return headers;
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.className = `response ${isError ? 'alert-error' : 'alert-success'}`;
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.querySelector('.content').insertBefore(alert, document.querySelector('.content').firstChild);
            setTimeout(() => alert.remove(), 5000);
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }

        async function login() {
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    showAlert('‚ùå Please enter username and password', 'error');
                    return;
                }

                // For now, use simple credential check
                if ((username === 'superadmin' && password === 'superadmin123') ||
                    (username === 'managedadmin' && password === 'managedadmin123') ||
                    (username === 'admin' && password === 'admin123')) {
                    
                    authToken = 'admin-token';
                    currentUser = {
                        fullName: username === 'superadmin' ? 'Super Administrator' : 
                                 username === 'managedadmin' ? 'Managed Administrator' : 'System Administrator',
                        role: username === 'superadmin' ? 'super_admin' : 
                              username === 'managedadmin' ? 'managed_admin' : 'admin'
                    };

                    // Show user info in header
                    document.getElementById('currentUserName').textContent = `Welcome, ${currentUser.fullName} (${currentUser.role})`;
                    document.getElementById('userInfo').style.display = 'block';

                    showAlert('‚úÖ Login successful! Welcome ' + currentUser.fullName, 'success');
                    showMainDashboard();
                } else {
                    showAlert('‚ùå Invalid credentials. Try: superadmin/superadmin123', 'error');
                }
                
            } catch (error) {
                showAlert(`‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        function showMainDashboard() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('createAccountSection').classList.remove('active');
            document.getElementById('manageAccountsSection').classList.remove('active');
            document.getElementById('configSection').classList.remove('active');
            loadStats();
        }

        function showCreateAccount() {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('createAccountSection').classList.add('active');
            document.getElementById('manageAccountsSection').classList.remove('active');
            document.getElementById('configSection').classList.remove('active');
        }

        function showManageAccounts() {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('createAccountSection').classList.remove('active');
            document.getElementById('manageAccountsSection').classList.add('active');
            document.getElementById('configSection').classList.remove('active');
            loadTenants();
        }

                 function showConfig() {
             document.getElementById('mainDashboard').style.display = 'none';
             document.getElementById('createAccountSection').classList.remove('active');
             document.getElementById('manageAccountsSection').classList.remove('active');
             document.getElementById('configSection').classList.add('active');
         }

         function generateUsername() {
             const email = document.getElementById('adminEmail').value;
             if (email) {
                 const username = email.split('@')[0];
                 document.getElementById('adminUsername').value = username;
             }
         }

        async function createTenant() {
            try {
                                 const tenantData = {
                     name: document.getElementById('institutionName').value,
                     address: document.getElementById('institutionAddress').value,
                     contact_phone: document.getElementById('institutionPhone').value,
                     plan: document.getElementById('subscriptionPlan').value,
                     timezone: document.getElementById('timezone').value,
                     default_admin: {
                         email: document.getElementById('adminEmail').value,
                         username: document.getElementById('adminUsername').value,
                         fullName: document.getElementById('adminName').value,
                         phone: document.getElementById('adminPhone').value,
                         password: document.getElementById('adminPassword').value
                     }
                 };

                                 // Validate required fields - removed slug requirement
                 if (!tenantData.name || !tenantData.default_admin.email || 
                     !tenantData.default_admin.username || !tenantData.default_admin.fullName || 
                     !tenantData.default_admin.password) {
                     showAlert('‚ùå Please fill in all required fields', 'error');
                     return;
                 }

                const data = await makeRequest(getApiUrl('/api/v1/managed-admin/tenants'), {
                    method: 'POST',
                    body: JSON.stringify(tenantData)
                });

                showAlert('‚úÖ Institution account created successfully!', 'success');
                showResponse('createResult', data);
                
                                 // Clear form
                 document.getElementById('institutionName').value = '';
                 document.getElementById('institutionAddress').value = '';
                 document.getElementById('institutionPhone').value = '';
                 document.getElementById('adminName').value = '';
                 document.getElementById('adminEmail').value = '';
                 document.getElementById('adminUsername').value = '';
                 document.getElementById('adminPhone').value = '';
                 document.getElementById('adminPassword').value = '';
                
                // Switch to Manage Accounts tab and refresh the list
                setTimeout(() => {
                    showManageAccounts();
                    loadTenants();
                }, 1000);
                
            } catch (error) {
                showAlert(`‚ùå Failed to create institution: ${error.message}`, 'error');
            }
        }

        async function loadTenants() {
            try {
                const tenantsList = document.getElementById('tenantsList');
                tenantsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading institution accounts...</p></div>';

                const data = await makeRequest(getApiUrl('/api/v1/managed-admin/tenants'));
                
                if (data.tenants && data.tenants.length > 0) {
                    tenantsList.innerHTML = data.tenants.map(tenant => `
                        <div class="tenant-card">
                            <div class="tenant-header">
                                <div class="tenant-name">${tenant.name}</div>
                                <div class="tenant-status status-${tenant.suspended ? 'suspended' : 'active'}">
                                    ${tenant.suspended ? 'Suspended' : 'Active'}
                                </div>
                            </div>
                                                         <div class="tenant-info">
                                 <p><strong>Slug:</strong> ${tenant.slug}</p>
                                 <p><strong>Contact:</strong> ${tenant.contact_email}</p>
                                 <p><strong>Plan:</strong> ${tenant.plan}</p>
                                 <p><strong>Created:</strong> ${new Date(tenant.created_at).toLocaleDateString()}</p>
                                                                    <p><strong>Admin Email:</strong> ${tenant.default_admin?.email || 'N/A'}</p>
                                   <p><strong>Admin Username:</strong> ${tenant.default_admin?.username || 'N/A'}</p>
                                   <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                       <p class="text-sm font-semibold text-blue-800 mb-2">üîó Institution Login URL:</p>
                                       <div class="flex items-center space-x-2">
                                           <a href="https://cbt.netlify.app/?slug=${tenant.slug}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-medium flex-1">https://cbt.netlify.app/?slug=${tenant.slug}</a>
                                           <button onclick="copyToClipboard('https://cbt.netlify.app/?slug=${tenant.slug}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">Copy</button>
                                       </div>
                                   </div>
                             </div>
                                                         <div class="tenant-actions">
                                 <button class="btn btn-small" onclick="viewTenantDetails('${tenant._id}')">View Details</button>
                                                                   <button class="btn btn-small btn-success" onclick="window.open('https://cbt.netlify.app/?slug=${tenant.slug}', '_blank')">Visit Login Page</button>
                                 <button class="btn btn-small btn-warning" onclick="resetAdminPassword('${tenant._id}')">Reset Password</button>
                                 ${tenant.suspended ? 
                                     `<button class="btn btn-small btn-success" onclick="reinstateTenant('${tenant._id}')">Activate</button>` :
                                     `<button class="btn btn-small btn-warning" onclick="suspendTenant('${tenant._id}')">Suspend</button>`
                                 }
                                 <button class="btn btn-small btn-danger" onclick="removeTenant('${tenant._id}')">Remove</button>
                             </div>
                        </div>
                    `).join('');
                } else {
                    tenantsList.innerHTML = '<div class="loading"><p>No institution accounts found.</p></div>';
                }
            } catch (error) {
                showAlert(`‚ùå Failed to load accounts: ${error.message}`, 'error');
                document.getElementById('tenantsList').innerHTML = '<div class="loading"><p>Error loading accounts.</p></div>';
            }
        }

        async function loadStats() {
            try {
                const data = await makeRequest(getApiUrl('/api/v1/managed-admin/tenants'));
                const tenants = data.tenants || [];
                
                document.getElementById('totalTenants').textContent = tenants.length;
                document.getElementById('activeTenants').textContent = tenants.filter(t => !t.suspended).length;
                document.getElementById('suspendedTenants').textContent = tenants.filter(t => t.suspended).length;
                document.getElementById('expiringSoon').textContent = '0'; // Placeholder
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function suspendTenant(tenantId) {
            if (!confirm('Are you sure you want to suspend this institution?')) return;
            
            try {
                const data = await makeRequest(getApiUrl(`/api/v1/managed-admin/tenants/${tenantId}/suspend`), {
                    method: 'POST',
                    body: JSON.stringify({ reason: 'Suspended by admin' })
                });
                showAlert('‚úÖ Institution suspended successfully!', 'success');
                loadTenants();
            } catch (error) {
                showAlert(`‚ùå Failed to suspend institution: ${error.message}`, 'error');
            }
        }

        async function reinstateTenant(tenantId) {
            if (!confirm('Are you sure you want to activate this institution?')) return;
            
            try {
                const data = await makeRequest(getApiUrl(`/api/v1/managed-admin/tenants/${tenantId}/reinstate`), {
                    method: 'POST'
                });
                showAlert('‚úÖ Institution activated successfully!', 'success');
                loadTenants();
            } catch (error) {
                showAlert(`‚ùå Failed to activate institution: ${error.message}`, 'error');
            }
        }

        async function resetAdminPassword(tenantId) {
            if (!confirm('Are you sure you want to reset the admin password?')) return;
            
            try {
                const data = await makeRequest(getApiUrl(`/api/v1/managed-admin/tenants/${tenantId}/reset-default-admin`), {
                    method: 'POST'
                });
                showAlert('‚úÖ Admin password reset successfully!', 'success');
                showResponse('createResult', data);
            } catch (error) {
                showAlert(`‚ùå Failed to reset password: ${error.message}`, 'error');
            }
        }

        async function removeTenant(tenantId) {
            if (!confirm('Are you sure you want to remove this institution? This action cannot be undone.')) return;
            
            try {
                const data = await makeRequest(getApiUrl(`/api/v1/managed-admin/tenants/${tenantId}`), {
                    method: 'DELETE'
                });
                showAlert('‚úÖ Institution removed successfully!', 'success');
                loadTenants();
            } catch (error) {
                showAlert(`‚ùå Failed to remove institution: ${error.message}`, 'error');
            }
        }

        async function viewTenantDetails(tenantId) {
            try {
                const data = await makeRequest(getApiUrl(`/api/v1/managed-admin/tenants/${tenantId}`));
                showResponse('createResult', data);
            } catch (error) {
                showAlert(`‚ùå Failed to get tenant details: ${error.message}`, 'error');
            }
        }

        async function exportTenants() {
            try {
                const data = await makeRequest(getApiUrl('/api/v1/managed-admin/tenants'));
                const csvContent = "data:text/csv;charset=utf-8," + 
                    "Name,Slug,Email,Plan,Status,Created\n" +
                    data.tenants.map(t => 
                        `${t.name},${t.slug},${t.contact_email},${t.plan},${t.suspended ? 'Suspended' : 'Active'},${new Date(t.created_at).toLocaleDateString()}`
                    ).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "institutions.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('‚úÖ Data exported successfully!', 'success');
            } catch (error) {
                showAlert(`‚ùå Failed to export data: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            try {
                const data = await makeRequest(getApiUrl('/health'));
                showAlert('‚úÖ Connection successful!', 'success');
                showResponse('configResult', data);
            } catch (error) {
                showAlert(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('createAccountSection').classList.remove('active');
            document.getElementById('manageAccountsSection').classList.remove('active');
            document.getElementById('configSection').classList.remove('active');
            showAlert('‚úÖ Logged out successfully', 'success');
        }

                 // Copy URL to clipboard function
         function copyToClipboard(text) {
             navigator.clipboard.writeText(text).then(() => {
                 showAlert('‚úÖ URL copied to clipboard!', 'success');
             }).catch(() => {
                 // Fallback for older browsers
                 const textArea = document.createElement('textarea');
                 textArea.value = text;
                 document.body.appendChild(textArea);
                 textArea.select();
                 document.execCommand('copy');
                 document.body.removeChild(textArea);
                 showAlert('‚úÖ URL copied to clipboard!', 'success');
             });
         }
         
         // Auto-load stats on page load (only if authenticated)
         window.addEventListener('load', () => {
             if (authToken) {
                 loadStats();
             }
         });
    </script>
</body>
</html>

